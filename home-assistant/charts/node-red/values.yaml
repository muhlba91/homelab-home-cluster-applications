---
packages:
  - name: bcryptjs
    version: 2.4.3
  - name: js-yaml
    version: 4.1.0
  - name: full-icu
    version: 1.5.0
  - name: node-red-contrib-actionflows
    version: 2.1.2
  - name: node-red-contrib-alexa-home-skill
    version: 0.1.19
  - name: node-red-contrib-bigtimer
    version: 2.8.5
  - name: node-red-contrib-castv2
    version: 4.3.0
  - name: node-red-contrib-counter
    version: 0.1.6
  - name: node-red-contrib-home-assistant-websocket
    version: 0.57.2
  - name: node-red-contrib-influxdb
    version: 0.6.1
  - name: node-red-contrib-interval-length
    version: 0.0.6
  - name: node-red-contrib-looptimer-advanced
    version: 0.0.8
  - name: node-red-contrib-modbus
    version: 5.27.2
  - name: node-red-contrib-moment
    version: 5.0.0
  - name: node-red-contrib-persistent-fsm
    version: 1.2.1
  - name: node-red-contrib-statistics
    version: 2.2.2
  - name: node-red-contrib-stoptimer
    version: 0.0.7
  - name: node-red-contrib-sunevents
    version: 3.1.1
  - name: node-red-contrib-time-range-switch
    version: 1.2.0
  - name: node-red-contrib-timecheck
    version: 1.1.0
  - name: node-red-contrib-traffic
    version: 0.2.1
  - name: node-red-dashboard
    version: 3.6.0
  - name: node-red-node-base64
    version: 0.3.0
  - name: node-red-node-email
    version: 2.0.1
  - name: node-red-node-geofence
    version: 0.3.4
  - name: node-red-node-msgpack
    version: 1.2.1
  - name: node-red-node-ping
    version: 0.3.3
  - name: node-red-node-smooth
    version: 0.1.2
  - name: node-red-node-suncalc
    version: 1.1.0
  - name: "@node-red-contrib-themes/theme-collection"
    version: 3.1.2
  - name: node-red-contrib-countdown-2
    version: 1.4.2
  - name: node-red-contrib-mytimeout
    version: 3.2.2
  - name: "@govtechsg/passport-openidconnect"
    version: 1.0.2
  - name: jsonwebtoken
    version: 9.0.2
  - name: jwks-rsa
    version: 3.1.0
  - name: node-red-contrib-telegrambot
    version: 15.1.7
  - name: node-red-contrib-uspatata-influxdb-v2
    version: 1.0.6

domain: &domain node-red.dev.iot.internal.muehlbachler.io

oidcUserProperty: preferred_username
adminUsers:
  - daniel

projectsEnabled: &projectsEnabled "false"

app-template:
  global:
    fullnameOverride: node-red

  controllers:
    main:
      type: statefulset
      containers:
        main:
          image:
            repository: ghcr.io/muhlba91/node-red
            pullPolicy: IfNotPresent
            tag: v4.0.0

          env:
            - name: TZ
              value: UTC
            - name: NODE_RED_ENABLE_PROJECTS
              value: *projectsEnabled
            - name: FLOWS
              value: flows.json
            - name: NODE_RED_URL
              valueFrom:
                configMapKeyRef:
                  name: node-red-config
                  key: url

          envFrom:
            - secretRef:
                name: node-red-credentials

          probes:
            startup:
              spec:
                initialDelaySeconds: 30
                periodSeconds: 15
                failureThreshold: 90
            readiness:
              spec:
                initialDelaySeconds: 10
            liveness:
              spec:
                initialDelaySeconds: 10

          resources:
            requests:
              cpu: 10m
              memory: 256Mi
            # necessary for yarn!
            limits:
              cpu: '1'
              memory: 1Gi

      initContainers:
        init-chown-data:
          image:
            repository: alpine
            tag: 3.18
            pullPolicy: IfNotPresent
          command:
            - chown
            - '-R'
            - '1000:0'
            - /data
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
          securityContext:
            capabilities:
              add:
                - CHOWN
        init-chown-node-modules:
          image:
            repository: alpine
            tag: 3.18
            pullPolicy: IfNotPresent
          imagePullPolicy: IfNotPresent
          command:
            - chown
            - '-R'
            - '1000:0'
            - /node_modules
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
          securityContext:
            capabilities:
              add:
                - CHOWN

    backup:
      type: cronjob
      cronjob:
        concurrencyPolicy: Replace
        schedule: 0 0 * * *
        successfulJobsHistory: 3
        failedJobsHistory: 3
        startingDeadlineSeconds: 30
        backoffLimit: 2
      pod:
        restartPolicy: OnFailure
        automountServiceAccountToken: true
      containers:
        backup:
          image:
            repository: python
            tag: 3.11-alpine
            pullPolicy: IfNotPresent
          command:
            - /scripts/backup_restore.sh
          envFrom:
            - secretRef:
                name: node-red-backup
            - secretRef:
                name: node-red-credentials
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 1
              memory: 256Mi

  serviceAccount:
    create: true

  defaultPodOptions:
    automountServiceAccountToken: false

  service:
    main:
      ipFamilyPolicy: PreferDualStack
      ports:
        http:
          port: 1880

  ingress:
    main:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: cluster-issuer-internal-muehlbachler-io
        external-dns.alpha.kubernetes.io/provider: internal
        traefik.ingress.kubernetes.io/router.tls: "true"
      hosts:
        - host: *domain
          paths:
            - path: /
              pathType: ImplementationSpecific
              service:
                name: node-red
                port: 1880
      tls:
        - secretName: home-assistant-node-red-tls-cert
          hosts:
            - *domain

  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      storageClass: longhorn
      accessMode: ReadWriteOnce
      size: 1Gi
      retain: false
    node-modules:
      enabled: true
      type: persistentVolumeClaim
      storageClass: longhorn
      accessMode: ReadWriteOnce
      size: 1Gi
      retain: false
      advancedMounts:
        main:
          main:
            - path: /usr/src/node-red/node_modules
          init-chown-node-modules:
            - path: /node_modules
    packages:
      enabled: true
      type: configMap
      name: node-red-config
      globalMounts:
        - path: /init
    scripts:
      enabled: true
      type: configMap
      name: node-red-scripts
      defaultMode: 511
      advancedMounts:
        backup:
          backup:
            - path: /scripts
