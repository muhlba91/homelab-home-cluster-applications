---
gitRepo: repo.com/config.git

app-template:
  global:
    fullnameOverride: home-assistant

  controllers:
    main:
      type: statefulset
      containers:
        main:
          image:
            repository: ghcr.io/home-assistant/home-assistant
            pullPolicy: IfNotPresent
            tag: 2023.10.4

          env:
            - name: TZ
              value: UTC
            - name: DATA_PATH
              value: /config
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /gcp-credentials/credentials.json
            - name: GOOGLE_CREDENTIALS
              valueFrom:
                secretKeyRef:
                  name: home-assistant-gcp-credentials
                  key: credentials.json

          envFrom:
            - secretRef:
                name: home-assistant-backup
            - configMapRef:
                name: home-assistant-git

          resources:
            requests:
              cpu: 100m
              memory: 1024Mi
            limits:
              cpu: 1
              memory: 1280Mi

      initContainers:
        backup-restore:
          image:
            repository: alpine
            tag: 3.18
            pullPolicy: IfNotPresent
          command:
            - /scripts/backup_restore.sh
            - "true"
          envFrom:
            - secretRef:
                name: home-assistant-backup
            - configMapRef:
                name: home-assistant-git
          env:
            - name: DATA_PATH
              value: /config
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /gcp-credentials/credentials.json
            - name: GOOGLE_CREDENTIALS
              valueFrom:
                secretKeyRef:
                  name: home-assistant-gcp-credentials
                  key: credentials.json
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 1
              memory: 256Mi

  serviceAccount:
    create: true

  defaultPodOptions:
    automountServiceAccountToken: false

  service:
    main:
      ipFamilyPolicy: PreferDualStack
      ports:
        http:
          port: 8123

  ingress:
    main:
      enabled: true

  persistence:
    config:
      enabled: true
      type: persistentVolumeClaim
      storageClass: longhorn
      accessMode: ReadWriteOnce
      size: 5Gi
      retain: false
    scripts:
      enabled: true
      type: configMap
      name: home-assistant-scripts
      defaultMode: 0o0777
    gcp-credentials:
      enabled: true
      type: secret
      name: home-assistant-gcp-credentials
      globalMounts:
        - path: /gcp-credentials
          readOnly: true
