---
apiVersion: v1
kind: ConfigMap
metadata:
  name: home-assistant-scripts
data:
  backup_restore.sh: |
    #!/bin/sh

    apk --no-cache add git s3cmd bash
    wget -O /usr/bin/sops https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64 &> /dev/null
    chmod +x /usr/bin/sops

    rm -rf /tmp/repo
    git clone ${GIT_REPO} /tmp/repo
    cd /tmp/repo

    /tmp/repo/lifecycle/sops.sh d /tmp/repo
    /tmp/repo/lifecycle/backup_restore.sh ${DATA_PATH} /tmp/repo
    /tmp/repo/lifecycle/prepare.sh ${DATA_PATH} /tmp/repo
