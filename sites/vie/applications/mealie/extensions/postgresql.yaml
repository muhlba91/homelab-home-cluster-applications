---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: mealie-postgresql
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: enabled
spec:
  instances: 1

  imageName: ghcr.io/cloudnative-pg/postgresql:18.0

  storage:
    size: 10Gi
    storageClass: ${DEFAULT_STORAGE_CLASS}

  resources:
    requests:
      cpu: 20m
      memory: 256Mi
    limits:
      memory: 512Mi

  enableSuperuserAccess: true
  managed:
    roles:
      - name: mealie
        ensure: present
        comment: Mealie
        login: true
        superuser: true
        passwordSecret:
          name: mealie-database

  bootstrap:
    # initdb:
    #   database: mealie
    #   owner: mealie
    #   encoding: UTF8
    #   secret:
    #     name: mealie-database
    recovery:
      source: mealie-postgresql-backup
      database: mealie
      owner: mealie
      secret:
        name: mealie-database

  plugins:
    - name: barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters:
        barmanObjectName: mealie-postgresql
        serverName: postgresql

  externalClusters:
    - name: mealie-postgresql-backup
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: mealie-postgresql
          serverName: postgresql
