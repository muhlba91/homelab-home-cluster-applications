---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: dex-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-auth
  target:
    name: dex-config
    template:
      engineVersion: v2
      data:
        config.yaml: |-
          issuer: https://auth.${PUBLIC_DOMAIN}/api/dex
          oauth2:
            skipApprovalScreen: true
          storage:
            type: memory
          connectors:
            - type: github
              id: github
              name: GitHub
              config:
                clientID: {{ .github_client_id }}
                clientSecret: {{ .github_client_secret }}
                redirectURI: https://auth.${PUBLIC_DOMAIN}/api/dex/callback
                teamNameField: slug
                orgs:
                  - name: fhburgenland-bswe
          staticClients:
            - id: argo-cd
              secret: {{ .dex_argocd_client_secret }}
              name: Argo CD
              redirectURIs:
                - https://argocd.${PUBLIC_DOMAIN}/api/dex/callback
            - id: harbor
              secret: {{ .dex_harbor_client_secret }}
              name: Harbor
              redirectURIs:
                - https://registry.${PUBLIC_DOMAIN}/c/oidc/callback
  data:
    - secretKey: github_client_id
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: dex-github
        property: client_id
    - secretKey: github_client_secret
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: dex-github
        property: client_secret
    - secretKey: dex_harbor_client_secret
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: dex-harbor
        property: client_secret
    - secretKey: dex_argocd_client_secret
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: dex-argocd
        property: client_secret
