---
fullnameOverride: victoria-metrics

crds:
  enabled: true

victoria-metrics-operator:
  enabled: true
  operator:
    disable_prometheus_converter: false
    enable_converter_ownership: true
  service:
    ipFamilyPolicy: PreferDualStack
  resources:
    requests:
      cpu: 10m
      memory: 192Mi
    limits:
      memory: 192Mi

defaultDashboards:
  enabled: true
  grafanaOperator:
    enabled: false
  dashboards:
    victoriametrics-vmalert:
      enabled: true
    victoriametrics-operator:
      enabled: true
    node-exporter-full:
      enabled: true

defaultRules:
  create: true
  groups:
    etcd:
      create: false
    general:
      create: true
    k8sContainerCpuLimits:
      create: true
    k8sContainerCpuRequests:
      create: true
    k8sContainerCpuUsageSecondsTotal:
      create: true
    k8sContainerMemoryLimits:
      create: true
    k8sContainerMemoryRequests:
      create: true
    k8sContainerMemoryRss:
      create: true
    k8sContainerMemoryCache:
      create: true
    k8sContainerMemoryWorkingSetBytes:
      create: true
    k8sContainerMemorySwap:
      create: true
    k8sPodOwner:
      create: true
    k8sContainerResource:
      create: true
    kubeApiserver:
      create: true
    kubeApiserverAvailability:
      create: true
    kubeApiserverBurnrate:
      create: true
    kubeApiserverHistogram:
      create: true
    kubeApiserverSlos:
      create: true
    kubelet:
      create: true
    kubePrometheusGeneral:
      create: true
    kubePrometheusNodeRecording:
      create: true
    kubernetesApps:
      create: true
      targetNamespace: ".*"
    kubernetesResources:
      create: true
    kubernetesStorage:
      create: true
      targetNamespace: ".*"
    kubernetesSystem:
      create: true
    kubernetesSystemKubelet:
      create: true
    kubernetesSystemApiserver:
      create: true
    kubernetesSystemControllerManager:
      create: true
    kubeScheduler:
      create: true
    kubernetesSystemScheduler:
      create: true
    kubeStateMetrics:
      create: true
    nodeNetwork:
      create: true
    node:
      create: true
    vmagent:
      create: true
    vmsingle:
      create: true
    vmcluster:
      create: false
    vmHealth:
      create: true
    vmoperator:
      create: true
    alertmanager:
      create: false

vmsingle:
  enabled: true
  annotations:
    helm.toolkit.fluxcd.io/driftDetection: disabled
  spec:
    retentionPeriod: "14"
    replicaCount: 1
    logLevel: WARN
    extraArgs:
      maxLabelsPerTimeseries: "150"
    serviceSpec:
      spec:
        ipFamilyPolicy: PreferDualStack
    resources:
      requests:
        cpu: 22m
        memory: 1511Mi
      limits:
        memory: 1511Mi
    storage:
      storageClassName: ${DEFAULT_STORAGE_CLASS}
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 20Gi
  ingress:
    enabled: false

vmcluster:
  enabled: false

alertmanager:
  enabled: false

vmalert:
  enabled: false

vmagent:
  enabled: true
  spec:
    scrapeInterval: 120s
    minScrapeInterval: 60s
    maxScrapeInterval: 900s
    logLevel: WARN
    extraArgs:
      enableTCP6: true
    serviceSpec:
      spec:
        ipFamilyPolicy: PreferDualStack
    resources:
      requests:
        cpu: 53m
        memory: 515Mi
      limits:
        memory: 512Mi

grafana:
  enabled: false
  forceDeployDatasource: true
  sidecar:
    datasources:
      label: grafana_datasource
    dashboards:
      label: grafana_dashboard

prometheus-node-exporter:
  enabled: true
  service:
    ipDualStack:
      enabled: true
  resources:
    requests:
      cpu: 10m
      memory: 100Mi
    limits:
      memory: 100Mi

kube-state-metrics:
  enabled: true
  service:
    ipDualStack:
      enabled: true
  resources:
    requests:
      cpu: 10m
      memory: 130Mi
    limits:
      memory: 130Mi

kubelet:
  enabled: true
  vmScrape:
    spec:
      metricRelabelConfigs:
        - action: labeldrop
          regex: (uid)
        - action: labeldrop
          regex: (id|name)
        - action: labeldrop
          regex: "extensions_talos_dev_.*"
        - action: labeldrop
          regex: "feature_node_kubernetes_io_.*"
        - action: labeldrop
          regex: "nvidia_com_.*"
        - action: drop
          source_labels: [__name__]
          regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)

kubeApiserver:
  enabled: true

kubeControllerManager:
  enabled: true
  service:
    selector:
      component: kube-controller-manager
  spec:
    jobLabel: jobLabel
    endpoints:
      - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
        # bearerTokenSecret:
        #   key: ""
        port: http-metrics
        scheme: https
        tlsConfig:
          insecureSkipVerify: true
          caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          serverName: kubernetes

kubeDns:
  enabled: false

coreDns:
  enabled: true

kubeEtcd:
  enabled: false # restricted by certificates

kubeScheduler:
  enabled: true
  service:
    selector:
      component: kube-scheduler
  spec:
    jobLabel: jobLabel
    endpoints:
      - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
        port: http-metrics
        scheme: https
        tlsConfig:
          insecureSkipVerify: true
          caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt

kubeProxy: # disabled
  enabled: false
