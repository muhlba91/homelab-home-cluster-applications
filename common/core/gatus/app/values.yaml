---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/common-4.2.0/charts/library/common/values.schema.json
global:
  alwaysAppendIdentifierToResourceName: true

controllers:
  main:
    annotations:
      reloader.stakater.com/auto: "true"
    serviceAccount:
      identifier: gatus
    initContainers:
      init-config:
        image: &configSyncImage
          repository: ghcr.io/kiwigrid/k8s-sidecar
          tag: 2.1.2

        env:
          FOLDER: /config
          LABEL: gatus.io/enabled
          NAMESPACE: ALL
          RESOURCE: both
          UNIQUE_FILENAMES: true
          METHOD: LIST

        resources: &configSyncResources
          requests:
            cpu: 10m
            memory: 125Mi
          limits:
            memory: 125Mi

        probes: &configSyncProbes
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /healthz
                port: 8080
              initialDelaySeconds: 35
              periodSeconds: 10
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /healthz
                port: 8080
              initialDelaySeconds: 20
              periodSeconds: 5
    containers:
      gatus:
        image:
          repository: ghcr.io/twin/gatus
          pullPolicy: IfNotPresent
          tag: v5.30.0

        env:
          - name: GATUS_CONFIG_PATH
            value: /config
        envFrom:
          - secretRef:
              name: gatus-ntfy

        resources:
          requests:
            cpu: 10m
            memory: 138Mi
          limits:
            memory: 138Mi

        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
            spec:
              failureThreshold: 30
              periodSeconds: 5

      config-sync:
        image: *configSyncImage
        env:
          FOLDER: /config
          LABEL: gatus.io/enabled
          NAMESPACE: ALL
          RESOURCE: both
          UNIQUE_FILENAMES: true
          METHOD: WATCH
        resources: *configSyncResources
        probes: *configSyncProbes

serviceAccount:
  gatus: {}

service:
  gatus:
    controller: main
    ports:
      http:
        port: 8080

ingress:
  gatus:
    enabled: true
    annotations:
      cert-manager.io/cluster-issuer: "${PUBLIC_CLUSTER_ISSUER}"
      external-dns.alpha.kubernetes.io/provider: public
      external-dns.alpha.kubernetes.io/target: "${PUBLIC_IP}"
      traefik.ingress.kubernetes.io/router.tls: "true"
    hosts:
      - host: &domain status.${LOCAL_HOME_DOMAIN}
        paths:
          - path: /
            pathType: ImplementationSpecific
            service:
              identifier: gatus
              port: 8080
    tls:
      - secretName: gatus-tls-cert
        hosts:
          - *domain

persistence:
  data:
    enabled: true
    storageClass: ${DEFAULT_STORAGE_CLASS}
    accessMode: ReadWriteOnce
    size: 200Mi
    retain: false
    globalMounts:
      - path: /data
  config:
    enabled: true
    type: emptyDir
  config-file:
    enabled: true
    type: configMap
    name: gatus-config
    globalMounts:
      - path: /config/config.yaml
        subPath: config.yaml
