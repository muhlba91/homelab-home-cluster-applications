---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ./templates/repository.yaml
  - ./templates/release.yaml
  - ../../../../templates/gatus/internal-http
configMapGenerator:
  - name: ${APPLICATION}-values
    namespace: flux-system
    files:
      - values.yaml=values.yaml
configurations:
  - kustomizeconfig.yml
patches:
  - target:
      version: helm.toolkit.fluxcd.io/v2beta1
      kind: HelmRelease
      name: ${APPLICATION}
    patch: |-
      postRenderers:
        - kustomize:
            patches:
              - target:
                  version: v1
                  kind: Deployment
                  labelSelector: "app.kubernetes.io/controller=main,app.kubernetes.io/instance=frigate,app.kubernetes.io/name=frigate"
                patch: |-
                  apiVersion: apps/v1
                  kind: Deployment
                  metadata:
                    name: not-used
                  spec:
                    template:
                      spec:
                        containers:
                          - name: frigate
                            # runtimeClassName: nvidia # TODO: nvidia vs intel
                            resources:
                              requests:
                                squat.ai/coral: "1"
                                # nvidia.com/gpu: "1" # TODO: nvidia vs intel
                              limits:
                                squat.ai/coral: "1"
                                # nvidia.com/gpu: "1" # TODO: nvidia vs intel
