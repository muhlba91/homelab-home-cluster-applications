---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: &application frigate
  namespace: flux-system
spec:
  sourceRef:
    kind: GitRepository
    name: cluster-applications
  path: ./common/applications/frigate/app/
  interval: 10m
  retryInterval: 2m
  prune: true
  force: false
  wait: false
  postBuild:
    substitute:
      APPLICATION: *application
      APPLICATION_NAMESPACE: *application
      GATUS_NAME: Frigate
      GATUS_GROUP: 002 - Applications
  patches:
    - target:
        kind: HelmRelease
      patch: |-
        kind: HelmRelease
        metadata:
          name: not-used
          labels:
            mylabel: ok
        spec:
          postRenderers:
            - kustomize:
                patches:
                  - target:
                      version: v1
                      kind: Deployment
                      labelSelector: "app.kubernetes.io/controller=main,app.kubernetes.io/instance=frigate,app.kubernetes.io/name=frigate"
                    patch: |-
                      apiVersion: apps/v1
                      kind: Deployment
                      metadata:
                        name: not-used
                      spec:
                        template:
                          spec:
                            containers:
                              - name: frigate
                                # runtimeClassName: nvidia # TODO: nvidia vs intel
                                resources:
                                  requests:
                                    squat.ai/coral: "1"
                                    # nvidia.com/gpu: "1" # TODO: nvidia vs intel
                                  limits:
                                    squat.ai/coral: "1"
                                    # nvidia.com/gpu: "1" # TODO: nvidia vs intel
